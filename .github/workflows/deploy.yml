name: Deploy to Hosting Lotus

on:
  push:
    branches:
      - main  # ‡∏´‡∏£‡∏∑‡∏≠ master (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ branch ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)

jobs:
  web-deploy:
    name: üéâ Deploy
    runs-on: ubuntu-latest
    steps:
      # 1. ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å GitHub ‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
      - name: üöö Get latest code
        uses: actions/checkout@v4

      # 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PHP ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Æ‡∏™‡∏ï‡πå (8.2)
      - name: üü¢ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # 3. ‡∏•‡∏á Library ‡∏Ç‡∏≠‡∏á Laravel (Vendor)
      - name: üì¶ Install Composer Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      # 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Node.js ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSS/JS
      - name: üü° Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 5. ‡∏™‡∏±‡πà‡∏á Build ‡πÑ‡∏ü‡∏•‡πå Vite (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå build)
      - name: üî® Build Frontend (Vite)
        run: |
          npm install
          npm run build

      # ---------------------------------------------------
      # ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Å‡πâ‡∏≠‡∏ô: ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô)
      # ---------------------------------------------------

      # 6. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î "‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô" ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå cmucoop
      - name: üìÇ Sync Backend Code (to cmucoop)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /cmucoop/           # ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
          exclude: |                      # ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/public/** # ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ public ‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏¢‡∏Å‡πÑ‡∏õ‡πÉ‡∏™‡πà public_html)
            **/storage/*.key
            .env                          # ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏ö .env ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
            .env.example
            deploy.yml

      # 7. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î "‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô" (CSS/JS ‡∏ó‡∏µ‡πà Build ‡πÅ‡∏•‡πâ‡∏ß) ‡πÑ‡∏õ‡∏ó‡∏µ‡πà public_html
      - name: üìÇ Sync Frontend Assets (to public_html)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./public/build/      # ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô build
          server-dir: /domains/cmucoop.com/public_html/build/  # ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô public_html
